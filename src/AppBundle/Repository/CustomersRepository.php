<?php

namespace AppBundle\Repository;

use AppBundle\Entity\Customers;
use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query;

/**
 * CustomersRepository
 *
 * This class was generated by the PhpStorm "Php Annotations" Plugin. Add your
 * own custom repository methods below.
 */
class CustomersRepository extends EntityRepository
{

    public const VALID_ORDER_BY = [
      "ASCENDING" => "ASC",
      "DESCENDING" => "DESC",
    ];

    public function getAllCustomersByGivenOrder(string $order)
    {
        $order = strtoupper($order);

        $orderSanitized = array_key_exists($order, self::VALID_ORDER_BY)
          ? self::VALID_ORDER_BY[$order]
          : null;

        return $this->createQueryBuilder('c')
          ->orderBy('c.birthDate', $orderSanitized)
          ->getQuery()
          ->getResult();
    }

    public function getCustomerTotalSales(int $id)
    {
        return $this->createQueryBuilder('c')
          ->where('c.id = :id')
          ->setParameter('id', $id)
          ->leftJoin('c.sales', 'cs')
          ->leftJoin('cs.car', 'sc')
          ->addSelect('cs, sc')
          ->getQuery()
          ->getOneOrNullResult();
    }
}
